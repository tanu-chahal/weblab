<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No-Sandbox Flag Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .command-box {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            border-left: 4px solid #00ff00;
            overflow-x: auto;
        }
        
        .warning-box {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        
        .security-test {
            background: #d1ecf1;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #bee5eb;
            margin: 20px 0;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }
        
        .status-unknown { background: #f8f9fa; color: #6c757d; }
        .status-sandboxed { background: #d4edda; color: #155724; }
        .status-no-sandbox { background: #f8d7da; color: #721c24; }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-top: 4px solid #007bff;
        }
        
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .danger-btn {
            background: #dc3545;
        }
        
        .danger-btn:hover {
            background: #c82333;
        }
        
        .results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .env-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè¥‚Äç‚ò†Ô∏è No-Sandbox Flag Test</h1>
        <p>Testing Chrome's --no-sandbox flag behavior in restricted environments</p>
    </div>

    <div class="warning-box">
        <h3>‚ö†Ô∏è Security Warning</h3>
        <p><strong>The --no-sandbox flag disables Chrome's security sandbox!</strong></p>
        <p>This flag is primarily used in:</p>
        <ul>
            <li>CI/CD environments (GitHub Actions, Jenkins, etc.)</li>
            <li>Docker containers</li>
            <li>Automated testing environments</li>
            <li>Systems where kernel security features are limited</li>
        </ul>
        <p><strong>‚ö†Ô∏è Never use --no-sandbox in production or with untrusted content!</strong></p>
    </div>

    <div class="test-section">
        <h3>üöÄ How to Test</h3>
        
        <h4>1. Normal Chrome (With Sandbox):</h4>
        <div class="command-box">chrome http://localhost:8000/no-sandbox-test.html</div>
        
        <h4>2. Chrome with --no-sandbox flag:</h4>
        <div class="command-box">chrome --no-sandbox http://localhost:8000/no-sandbox-test.html</div>
        
        <h4>3. Full headless testing command:</h4>
        <div class="command-box">chrome --no-sandbox --headless --disable-gpu --remote-debugging-port=9222 http://localhost:8000/no-sandbox-test.html</div>
        
        <h4>4. Docker/CI environment typical flags:</h4>
        <div class="command-box">chrome --no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage --disable-extensions --disable-plugins --headless --dump-dom http://localhost:8000/no-sandbox-test.html</div>
    </div>

    <div class="security-test">
        <h3>üîí Sandbox Detection Tests</h3>
        <p>Current Status: <span id="sandbox-status" class="status-indicator status-unknown">Detecting...</span></p>
        
        <div class="env-info">
            <strong>Environment Information:</strong>
            <div id="env-info"></div>
        </div>
    </div>

    <div class="test-grid">
        <div class="test-card">
            <h4>üåê Web API Tests</h4>
            <p>Test various Web APIs that might behave differently without sandbox:</p>
            <button onclick="testWebAPIs()">Test Web APIs</button>
            <div id="webapi-results" class="results"></div>
        </div>

        <div class="test-card">
            <h4>üîê Security Context Tests</h4>
            <p>Test security-related browser features:</p>
            <button onclick="testSecurityContext()">Test Security Features</button>
            <div id="security-results" class="results"></div>
        </div>

        <div class="test-card">
            <h4>üíæ Storage Tests</h4>
            <p>Test storage APIs and persistence:</p>
            <button onclick="testStorageAPIs()">Test Storage</button>
            <div id="storage-results" class="results"></div>
        </div>

        <div class="test-card">
            <h4>üé• Media Tests</h4>
            <p>Test camera/microphone access (may require --no-sandbox in some environments):</p>
            <button onclick="testMediaAPIs()">Test Media APIs</button>
            <div id="media-results" class="results"></div>
        </div>

        <div class="test-card">
            <h4>üìÅ File System Tests</h4>
            <p>Test file system access capabilities:</p>
            <button onclick="testFileSystemAPIs()">Test File APIs</button>
            <div id="filesystem-results" class="results"></div>
        </div>

        <div class="test-card">
            <h4>‚ö° Performance Tests</h4>
            <p>Check if --no-sandbox affects performance:</p>
            <button onclick="testPerformance()">Run Performance Test</button>
            <div id="performance-results" class="results"></div>
        </div>
    </div>

    <div class="test-section">
        <h3>üê≥ Docker Test Example</h3>
        <p>If you're testing in Docker, here's a complete example:</p>
        <div class="command-box">
# Dockerfile example
FROM node:18-alpine
RUN apk add --no-cache chromium
ENV CHROME_BIN=/usr/bin/chromium-browser
ENV CHROME_PATH=/usr/bin/chromium-browser

# Run with no-sandbox
CMD ["chromium-browser", "--no-sandbox", "--headless", "--disable-gpu", "http://localhost:8000/no-sandbox-test.html"]
        </div>
    </div>

    <script>
        // Detect sandbox status on page load
        window.addEventListener('load', () => {
            detectSandboxStatus();
            showEnvironmentInfo();
        });

        function detectSandboxStatus() {
            const statusEl = document.getElementById('sandbox-status');
            
            // Check for common indicators of no-sandbox mode
            const indicators = [];
            
            // Check user agent for headless indicators
            if (navigator.userAgent.includes('HeadlessChrome')) {
                indicators.push('Headless Chrome detected');
            }
            
            // Check for webdriver
            if (navigator.webdriver) {
                indicators.push('WebDriver detected');
            }
            
            // Check for restricted permissions
            try {
                if (!window.chrome || !window.chrome.runtime) {
                    indicators.push('Chrome runtime unavailable');
                }
            } catch (e) {
                indicators.push('Chrome runtime error: ' + e.message);
            }

            // Check command line flags if available
            if (window.chrome && window.chrome.commandLine) {
                try {
                    const cmdLine = window.chrome.commandLine;
                    if (cmdLine.includes('--no-sandbox')) {
                        indicators.push('--no-sandbox flag detected');
                        statusEl.textContent = 'No Sandbox (Detected)';
                        statusEl.className = 'status-indicator status-no-sandbox';
                        return;
                    }
                } catch (e) {
                    indicators.push('Cannot access command line');
                }
            }

            // If we have indicators but no definitive proof, it's likely no-sandbox
            if (indicators.length > 0) {
                statusEl.textContent = 'Likely No Sandbox';
                statusEl.className = 'status-indicator status-no-sandbox';
            } else {
                statusEl.textContent = 'Likely Sandboxed';
                statusEl.className = 'status-indicator status-sandboxed';
            }

            console.log('Sandbox indicators:', indicators);
        }

        function showEnvironmentInfo() {
            const envInfo = document.getElementById('env-info');
            const info = [];
            
            info.push(`User Agent: ${navigator.userAgent}`);
            info.push(`Platform: ${navigator.platform}`);
            info.push(`Language: ${navigator.language}`);
            info.push(`Online: ${navigator.onLine}`);
            info.push(`Cookie Enabled: ${navigator.cookieEnabled}`);
            info.push(`WebDriver: ${!!navigator.webdriver}`);
            info.push(`Hardware Concurrency: ${navigator.hardwareConcurrency}`);
            info.push(`Max Touch Points: ${navigator.maxTouchPoints}`);
            
            if (window.chrome) {
                info.push(`Chrome Runtime: Available`);
            } else {
                info.push(`Chrome Runtime: Not Available`);
            }
            
            envInfo.innerHTML = info.join('<br>');
        }

        async function testWebAPIs() {
            const results = document.getElementById('webapi-results');
            const tests = [];
            
            // Test Geolocation API
            try {
                if ('geolocation' in navigator) {
                    tests.push('‚úÖ Geolocation API: Available');
                } else {
                    tests.push('‚ùå Geolocation API: Not Available');
                }
            } catch (e) {
                tests.push('‚ùå Geolocation API Error: ' + e.message);
            }
            
            // Test Notification API
            try {
                if ('Notification' in window) {
                    tests.push(`‚úÖ Notification API: Available (Permission: ${Notification.permission})`);
                } else {
                    tests.push('‚ùå Notification API: Not Available');
                }
            } catch (e) {
                tests.push('‚ùå Notification API Error: ' + e.message);
            }
            
            // Test Service Worker
            try {
                if ('serviceWorker' in navigator) {
                    tests.push('‚úÖ Service Worker: Available');
                } else {
                    tests.push('‚ùå Service Worker: Not Available');
                }
            } catch (e) {
                tests.push('‚ùå Service Worker Error: ' + e.message);
            }
            
            // Test WebRTC
            try {
                if ('RTCPeerConnection' in window) {
                    tests.push('‚úÖ WebRTC: Available');
                } else {
                    tests.push('‚ùå WebRTC: Not Available');
                }
            } catch (e) {
                tests.push('‚ùå WebRTC Error: ' + e.message);
            }
            
            results.textContent = tests.join('\n');
        }

        async function testSecurityContext() {
            const results = document.getElementById('security-results');
            const tests = [];
            
            // Test HTTPS context
            tests.push(`Protocol: ${location.protocol}`);
            tests.push(`Secure Context: ${window.isSecureContext}`);
            
            // Test CSP
            try {
                eval('1+1'); // This will fail if CSP blocks eval
                tests.push('‚úÖ eval() allowed (no strict CSP)');
            } catch (e) {
                tests.push('‚ùå eval() blocked (CSP active): ' + e.message);
            }
            
            // Test iframe access
            try {
                const iframe = document.createElement('iframe');
                iframe.src = 'about:blank';
                tests.push('‚úÖ iframe creation: Allowed');
            } catch (e) {
                tests.push('‚ùå iframe creation: Blocked - ' + e.message);
            }
            
            // Test cross-origin restrictions
            try {
                fetch('https://httpbin.org/json')
                    .then(() => tests.push('‚úÖ Cross-origin fetch: Allowed'))
                    .catch(e => tests.push('‚ùå Cross-origin fetch: Blocked - ' + e.message));
            } catch (e) {
                tests.push('‚ùå Fetch API Error: ' + e.message);
            }
            
            results.textContent = tests.join('\n');
        }

        async function testStorageAPIs() {
            const results = document.getElementById('storage-results');
            const tests = [];
            
            // Test localStorage
            try {
                localStorage.setItem('test', 'value');
                localStorage.removeItem('test');
                tests.push('‚úÖ localStorage: Working');
            } catch (e) {
                tests.push('‚ùå localStorage: Failed - ' + e.message);
            }
            
            // Test sessionStorage
            try {
                sessionStorage.setItem('test', 'value');
                sessionStorage.removeItem('test');
                tests.push('‚úÖ sessionStorage: Working');
            } catch (e) {
                tests.push('‚ùå sessionStorage: Failed - ' + e.message);
            }
            
            // Test IndexedDB
            try {
                if ('indexedDB' in window) {
                    const request = indexedDB.open('testDB', 1);
                    request.onsuccess = () => {
                        tests.push('‚úÖ IndexedDB: Working');
                        request.result.close();
                        indexedDB.deleteDatabase('testDB');
                        results.textContent = tests.join('\n');
                    };
                    request.onerror = () => {
                        tests.push('‚ùå IndexedDB: Failed to open');
                        results.textContent = tests.join('\n');
                    };
                } else {
                    tests.push('‚ùå IndexedDB: Not Available');
                }
            } catch (e) {
                tests.push('‚ùå IndexedDB Error: ' + e.message);
            }
            
            // Test Web SQL (deprecated but sometimes restricted)
            try {
                if ('openDatabase' in window) {
                    tests.push('‚ö†Ô∏è Web SQL: Available (deprecated)');
                } else {
                    tests.push('‚úÖ Web SQL: Not Available (good)');
                }
            } catch (e) {
                tests.push('‚ùå Web SQL Error: ' + e.message);
            }
            
            results.textContent = tests.join('\n');
        }

        async function testMediaAPIs() {
            const results = document.getElementById('media-results');
            const tests = [];
            
            // Test getUserMedia
            try {
                if ('mediaDevices' in navigator) {
                    tests.push('‚úÖ MediaDevices API: Available');
                    
                    // Try to enumerate devices
                    navigator.mediaDevices.enumerateDevices()
                        .then(devices => {
                            tests.push(`‚úÖ Media Devices Found: ${devices.length}`);
                            results.textContent = tests.join('\n');
                        })
                        .catch(e => {
                            tests.push('‚ùå Device Enumeration Failed: ' + e.message);
                            results.textContent = tests.join('\n');
                        });
                } else {
                    tests.push('‚ùå MediaDevices API: Not Available');
                }
            } catch (e) {
                tests.push('‚ùå MediaDevices Error: ' + e.message);
            }
            
            // Test Web Audio
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                tests.push('‚úÖ Web Audio: Working');
                audioContext.close();
            } catch (e) {
                tests.push('‚ùå Web Audio Error: ' + e.message);
            }
            
            results.textContent = tests.join('\n');
        }

        async function testFileSystemAPIs() {
            const results = document.getElementById('filesystem-results');
            const tests = [];
            
            // Test File API
            try {
                const input = document.createElement('input');
                input.type = 'file';
                tests.push('‚úÖ File Input: Available');
            } catch (e) {
                tests.push('‚ùå File Input Error: ' + e.message);
            }
            
            // Test FileReader
            try {
                const reader = new FileReader();
                tests.push('‚úÖ FileReader: Available');
            } catch (e) {
                tests.push('‚ùå FileReader Error: ' + e.message);
            }
            
            // Test Blob
            try {
                const blob = new Blob(['test'], { type: 'text/plain' });
                tests.push('‚úÖ Blob: Working');
            } catch (e) {
                tests.push('‚ùå Blob Error: ' + e.message);
            }
            
            // Test File System Access API (newer)
            try {
                if ('showOpenFilePicker' in window) {
                    tests.push('‚úÖ File System Access API: Available');
                } else {
                    tests.push('‚ùå File System Access API: Not Available');
                }
            } catch (e) {
                tests.push('‚ùå File System Access API Error: ' + e.message);
            }
            
            results.textContent = tests.join('\n');
        }

        async function testPerformance() {
            const results = document.getElementById('performance-results');
            const tests = [];
            
            // Test performance timing
            const startTime = performance.now();
            
            // CPU intensive task
            let sum = 0;
            for (let i = 0; i < 1000000; i++) {
                sum += Math.random();
            }
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            
            tests.push(`CPU Test Duration: ${duration.toFixed(2)}ms`);
            tests.push(`Performance API: ${performance ? 'Available' : 'Not Available'}`);
            
            // Memory usage (if available)
            if (performance.memory) {
                tests.push(`JS Heap Size: ${(performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`);
                tests.push(`JS Heap Limit: ${(performance.memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`);
            } else {
                tests.push('Memory Info: Not Available');
            }
            
            // Navigation timing
            if (performance.navigation) {
                tests.push(`Navigation Type: ${performance.navigation.type}`);
                tests.push(`Redirects: ${performance.navigation.redirectCount}`);
            }
            
            results.textContent = tests.join('\n');
        }

        // Auto-run basic detection
        setTimeout(() => {
            console.log('Running automatic sandbox detection...');
            detectSandboxStatus();
        }, 1000);
    </script>
</body>
</html>